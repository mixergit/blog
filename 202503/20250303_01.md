## 如何训练出类似deepseek-r1这样“会思考”的模型?   
              
### 作者              
digoal              
              
### 日期              
2025-03-03              
              
### 标签              
AI , 大模型 , 微调 , 监督微调 , 提示模版 , deepseek , 推理        
              
----              
              
## 背景       
有些大模型在generate或chat时会先返回\<think\>思考内容\<\/think\>, 然后输出响应结果, 这样的模型是怎么训练出来的?   
  
使用deepseek R1的模型时, 会先思考, 然后再输出. 感觉有点酷. 我们如何微调一个模型, 让它也先思考再回答, 从而提高回答的准确性?   
  
### 太长不看   
1、通过 **监督微调（SFT）**：  
- 输入：原始问题（如“如何计算圆的面积？”）。  
- 输出：强制模型按`<think>推导公式...</think> 答案...`格式生成。  
- 目标：让模型学会将思考过程与答案分离，并适应标签的语法结构。  
  
使用监督微调的方法, 在下面这篇信文章中进行了实践, 得到了输出思考内容的模型.    
- [《手把手教你炼丹 | 使用医疗诊断公开数据集微调专业医生大模型 , 中医崛起》](../202502/20250225_02.md)    
  
原始的数据集格式如下:    
```    
    {    
        "Question": "患者表现为干咳，或咯少量粘痰，有时痰中带血，胸部隐痛，午后手足心热，皮肤干灼，或有盗汗，舌质红苔薄，脉细数。请问该患者的中医辨证是什么？",    
        "Complex_CoT": "干咳，还有少量粘痰，有时痰中带血，这些症状听起来像是和肺部有关，可能有什么炎症或者热在作怪。我记得这种情况下有时候是因为肺里的津液不足。 \n\n \n\n接着，有午后手足心热这些表现，而且舌红，脉细数，感觉挺像是阴虚内热。如果是阴虚，体内的阴液不够，就容易这种内热的感觉。\n\n \n\n此外，患者居然还有皮肤干灼，有时出汗的症状！这些是典型的阴虚表现，尤其是肺阴虚的典型症状。看得出，是体内津  
液无法滋润皮肤导致的。\n\n \n\n所以综合起来，干咳、少痰、咳血，这说明肺阴虚外加点内热。这可能是因为阴虚，体内没有足够的津液滋润。\n\n \n\n嗯，细想一下，咳血还有可能是因为肺中有热，把血络给伤到了，更加说明内有热的感觉。这种情况应该就是阴虚然后内热引起的。 \n\n \n\n再有，患者说有胸部隐痛，这可能是气血不畅，还真挺符合阴虚导致的状况。这个痛说明虚火在身体里面扰动着。\n\n \n\n还有舌红苔薄，痰少，这些都和阴  
虚内热是一致的症状。患者阴虚的可能性更加大了，而且这和干咳症状很对得上。\n\n \n\n总是觉得症状和肺阴虚夹着内热的结合挺吻合。特别是干咳、皮肤干燥这些症状都在一个方向。\n\n \n\n再进一步想，肺阴亏虚是怎么样的呢？主要是津液不足导致外部的表现，因此有干咳、少痰还有皮肤干这些情况。哦，这和患者的症状基本完全吻合。\n\n \n\n所以，要是症状都是这种方向的话，归为肺阴亏虚应该是对的，也能解释所有的症状组合。影响了皮  
肤、呼吸等等，看来这个方向不容小视。\n\n \n\n这样子回头看看，所有症状的点线都很一致，确实是肺阴亏虚。这也符合大部分分析和患者症状的实际表现。",    
        "Response": "根据患者所表现的症状，干咳、少量粘痰、痰中带血、胸部隐痛、午后手足心热、皮肤干灼、盗汗、舌质红苔薄、脉细数，这些症状综合起来符合中医中的“肺阴虚”夹“内热”的表现。肺阴虚是指肺的阴液不  
足，无法滋润肺脏和其他相关系统，导致干咳、皮肤干燥等症状，而内热则会导致痰中带血、手足心热等表现。因此，该患者的中医辨证为“肺阴虚夹内热”。"    
    },    
    {    
        "Question": "一个患有急性阑尾炎的病人已经发病5天，腹痛稍有减轻但仍然发热，在体检时发现右下腹有压痛的包块，此时应如何处理？",    
        "Complex_CoT": "这个病人已经发病五天，腹痛稍微减轻但还在发烧，看起来情况有些复杂。哦，刚刚在体检中也发现了在右下腹有个压痛的包块，这让我想到可能是阑尾已经形成了包块或者脓肿。 \n\n既然包块已经形  
成，那急诊手术貌似不是个好主意。考虑到潜在的感染扩散和其他并发症，不如先尝试保守治疗吧。 \n\n所以，目前来说，最理想的方案可能是先控制感染，用抗生素治疗。同时，密切观察病情变化。如果这个包块真的发展成了  
脓肿，我觉得可能需要考虑穿刺引流。 \n\n那么接下来要是保守治疗起了作用，包块缩小或者症状改善很多，那就是好消息。不过，我想是得考虑等病人情况稳定下来后，再择期手术切掉这个已经愈合的阑尾，免得以后还要担心  
复发的问题。 \n\n总结一下，对于这种已经有包块的情况，保守治疗可以降低风险，等到病情稳定后再做手术应该是稳妥的方案。这样处理似乎才符合常规的医学原则，也更为安全。",    
        "Response": "这种情况下，病人很可能已经出现了阑尾周围炎性包块或者脓肿，因此建议采用保守治疗为主。首先，应通过抗生素控制感染，密切观察患者病情变化。在此期间，监测症状的进展和包块的变化是非常重要  
的。如果测试结果或病情表现出包块确实发展成了脓肿，可能需要考虑进行穿刺引流，以降低感染扩散的风险。\n\n如果经过一段时间的保守治疗后，包块缩小且症状明显改善，这表明对非手术治疗的响应良好。待病人病情完全稳定后，再考虑择期手术切除阑尾，以防止将来复发。\n\n总之，面对已形成包块或脓肿表现的急性阑尾炎患者，首选保守治疗以降低急诊手术的风险，然后在病情稳定后再进行阑尾切除是更为安全和合理的处理方案。"    
    },    
    ...    
```   
  
监督微调格式改成:   
```  
{"prompt": "$Question+tokenizer.eos_token", "completion": "\<think\>\n$Complex_CoT\n\</think\>\n+$Response+tokenizer.eos_token"}    
{"prompt": "$Question+tokenizer.eos_token", "completion": "\<think\>\n$Complex_CoT\n\</think\>\n+$Response+tokenizer.eos_token"}    
```  
  
2、通过提示词模版也可以达到同样的效果, 不过可能没有监督微调的效果好.     
  
  
## 方法正文  
  
训练能够生成带有明确思考过程（如`<think>...</think>`）的大模型，通常需要结合**结构化数据设计**、**特定训练策略**和**解码控制**，以下是实现这一效果的关键步骤和原理：  
  
  
### **1. 数据构建：结构化思维链标注**  
- **标注格式**：收集或构造包含“显式思考-答案对”的数据集，每个样本格式为：  
  ```text  
  用户：问题...  
  助手：<think>模型推理过程...</think> 答案...  
  ```  
- **数据来源**：  
  - **人工标注**：让标注员模拟模型的思考过程，拆分出中间推理步骤和最终答案。  
  - **自动生成**：利用现有模型（如GPT-4）生成思考过程，再人工校验修正。  
  - **合成数据**：将现有问答对（如CoQA、HotpotQA）改造为思考+答案格式。  
  
  
### **2. 训练策略：多阶段微调**  
- **预训练模型基础**：在通用大模型（如LLaMA、GPT）基础上进行微调。  
- **监督微调（SFT）**：  
  - 输入：原始问题（如“如何计算圆的面积？”）。  
  - 输出：强制模型按`<think>推导公式...</think> 答案...`格式生成。  
  - 目标：让模型学会将思考过程与答案分离，并适应标签的语法结构。  
- **强化学习（RLHF，可选）**：  
  - 对“思考-答案”对的逻辑一致性设计奖励函数（如答案正确性、思考相关性）。  
  - 通过人类反馈优化生成质量。  
  
  
### **3. 模型架构调整（可选）**  
- **分阶段生成**：部分模型通过修改注意力掩码，强制模型先生成`<think>`内容，再基于此生成答案。  
- **辅助损失函数**：为`<think>`部分设计独立损失，确保其与答案的逻辑关联性（如通过中间表示监督）。  
  
  
### **4. 解码控制：约束生成**  
- **模板引导**：在生成时预置模板，例如首先生成`<think>`，直到遇到`</think>`后继续生成答案。  
- **约束解码库**：使用工具（如Guidance、Outlines）强制模型按指定顺序生成内容。  
- **后处理**：若模型未正确分隔内容，可通过规则提取`<think>`部分并重组输出。  
  
  
### **5. 效果示例**  
- **输入**：    
  “法国的首都是哪里？”  
    
- **模型生成**：    
  `<think>法国是欧洲国家，首都通常是政治中心。巴黎是法国最大的城市，也是政府所在地。</think> 法国的首都是巴黎。`  
  
  
### **关键挑战**  
- **数据质量**：思考部分需真实有效，而非随意生成，否则会导致答案错误。  
- **标签鲁棒性**：模型需准确识别`<think>`边界，避免漏标或错标。  
- **计算成本**：生成两段内容（思考+答案）可能增加推理时间。  
  
  
### **实际应用案例**  
- **SELF-INSTRUCT**：通过模板将问题拆分为推理步骤和答案，用于微调模型。  
- **ALM（Automatic Latent Mind）**：显式建模中间推理步骤，并用特殊标记分隔。  
- **GPT-4的System Prompt**：通过提示词要求模型“先推理后回答”，但依赖模型的指令跟随能力，而非显式训练。  
  
  
通过上述方法，模型可以学会将内部推理过程显式化，提升生成结果的可解释性，同时帮助用户理解其逻辑链条。这种设计常见于教育、数学推理等需要透明化思考的领域。  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
