## 每天5分钟,PG聊通透 - 系列1 - 热门问题  
  
### 作者  
digoal  
  
### 日期  
2021-12-09  
  
### 标签  
PostgreSQL , 热门问题  
  
----  
  
## 背景  
- 问题说明(现象、环境)  
- 分析原因  
- 结论和解决办法  
  
## 本系列汇总  
### 链接、驱动、SQL  
##### 202112/20211224_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第24期 - 为什么与检索字段类型不一致的输入条件有时可能不能采用索引?》](../202112/20211224_05.md)  
##### 202112/20211224_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第23期 - 为什么有的函数不能被用来创建表达式索引?》](../202112/20211224_04.md)  
##### 202112/20211224_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第22期 - 为什么创建索引会堵塞DML? 如何在线创建索引?》](../202112/20211224_03.md)  
##### 202112/20211224_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第21期 - 为什么要用绑定变量?》](../202112/20211224_02.md)  
##### 202112/20211224_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第20期 - 为什么分区表的分区过多会导致性能下降?》](../202112/20211224_01.md)  
##### 202112/20211223_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第19期 - 为什么SQL性能会抖动?》](../202112/20211223_02.md)  
##### 202112/20211222_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第18期 - 为什么性能差? 如何找到捣蛋鬼SQL?》](../202112/20211222_05.md)  
##### 202112/20211222_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第17期 - 为什么说有些逻辑应该交给数据库存储过程来做?》](../202112/20211222_04.md)  
##### 202112/20211222_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第16期 - 为什么说有些排序操作建议让业务来做?》](../202112/20211222_03.md)  
##### 202112/20211222_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第15期 - 为什么业务开启多会话并行后反而变慢了?》](../202112/20211222_02.md)  
##### 202112/20211222_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第14期 - 为什么会有死锁?》](../202112/20211222_01.md)  
##### 202112/20211221_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第13期 - 为什么长时间等待业务处理的情况不建议封装在一个长事务中进行处理?》](../202112/20211221_03.md)  
##### 202112/20211221_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第12期 - 为什么SQL会自动启用并行计算?》](../202112/20211221_02.md)  
##### 202112/20211221_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第11期 - 为什么count查询慢?》](../202112/20211221_01.md)  
##### 202112/20211220_10.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第10期 - 为什么有的索引不支持字符串前置`like` `~`查询?》](../202112/20211220_10.md)  
##### 202112/20211220_09.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第9期 - 为什么OFFSET(翻页)会越来越慢?》](../202112/20211220_09.md)  
##### 202112/20211220_08.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第8期 - 为什么`order by`并没有按中文拼音排序?》](../202112/20211220_08.md)  
##### 202112/20211220_07.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第7期 - 为什么有的SQL使用`pg_cancel_backend, pg_terminate_backend`都杀不掉?》](../202112/20211220_07.md)  
##### 202112/20211220_06.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第6期 - 为什么不需要提供密码就能连接数据库?》](../202112/20211220_06.md)  
##### 202112/20211220_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第5期 - 为什么无法连接数据库?》](../202112/20211220_05.md)  
##### 202112/20211220_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第4期 - 为什么增加连接不能无限提高TPS或QPS? 配置多少个链接合适?》](../202112/20211220_04.md)  
##### 202112/20211220_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第3期 - 为什么会有大量的`idle in transaction|idle`事务? 有什么危害?》](../202112/20211220_03.md)  
##### 202112/20211220_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第2期 - 为什么会有莫名其妙的连接错误日志?》](../202112/20211220_02.md)  
##### 202112/20211220_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第1期 - 为什么数据库链接长时间空闲时有时侯会自动断开?》](../202112/20211220_01.md)  
  
  
### 备份、订阅、恢复  
  
1、为什么逻辑复制在主从切换后会丢数据?  
https://www.bilibili.com/video/BV1EL41187Rk/  
  
逻辑解析日志和wal日志是2条线.  
  
逻辑解析相对wal日志是异步操作. 所以可能是这样的:  
```  
--- 逻辑日志消费位置  
------ wal位置  
```  
  
物理从库在PG16前的版本都不支持逻辑复制, 也没有主库的逻辑复制的slot位点信息. 所以, 即使物理从库是和主库wal完全同步的, 也会丢失逻辑日志.  
```  
------ 激活, 创建逻辑slot  
   --- : 丢失了这些未解析的逻辑日志  
```  
  
怎么做到不丢失呢?  
- 仅当手工切换场景, 可以保证不丢失: 老的主库消费完所有日志, 拒绝从库的写操作, 激活从库为新主库, 在新主库创建逻辑slot, 开放新主库的写操作.  
  
  
  
2、为什么有备份但是不能恢复到指定时间点?   (时区指定有问题、目标时间早于全量备份到逻辑一致位点)  
https://www.bilibili.com/video/BV1GV4y1C7Cg/  
  
Postgresql 全量备份从`2021-01-01 10:00:00`开始, `2021-01-02 10:00:00`结束, 并且备份了从`2021-01-01 10:00:00`开始到`2021-01-03 10:00:00`的所有wal日志, 请问如果`2021-01-01 11:00:00` DROP了某个表, 是否能通过这个备份集恢复回来这张被drop的表的数据?  
  
备份集A:  
全量备份开始---------drop 某表------数据文件太多, 备份集里面没有备份到这个表的file------全量备份结束  
归档备份开始  
  
PITR, 使用备份集A恢复到“全量备份开始---------drop 某表” 之间的某个时刻.   请问是否可行?  如果可行, 恢复后某表还在吗?  
  
先思考几个问题：  
- 未开启全量备份的时候, DROP操作是否会将该表的数据写入WAL?  
- 在开启全量备份(start backup)开始后, stop backup前, DROP操作是否会将该表的数据写入WAL?  
  
答案是, DROP操作都不会将该表的数据写入WAL. 包括TRUNCATE也一样.  
  
验证过程:  
  
```  
确保wal级别是replica以上  
  
postgres=# show wal_level ;  
 wal_level  
-----------  
 replica  
(1 row)  
  
创建测试表  
  
postgres=# create table tbl (id int, info text, ct timestamp);  
CREATE TABLE  
postgres=# insert into tbl select generate_series(1,10000000), md5(random()::text), now();  
INSERT 0 10000000  
postgres=# vacuum tbl;  
VACUUM  
postgres=# checkpoint;  
CHECKPOINT  
  
开启物理备份  
  
postgres=# select pg_start_backup('abc');  
 pg_start_backup  
-----------------  
 1/A6000028  
(1 row)  
  
记录物理备份开始时的wal位置  
  
postgres=# select pg_current_wal_lsn();  
 pg_current_wal_lsn  
--------------------  
 1/A60000D8  
(1 row)  
  
查看测试表的数据文件位置  
  
postgres=# select pg_relation_filepath('tbl'::regclass);  
 pg_relation_filepath  
----------------------  
 base/14020/34126  
(1 row)  
  
IT-C02YW2EFLVDL:~ digoal$ cd $PGDATA  
IT-C02YW2EFLVDL:data14 digoal$ ll base/14020/34126*  
-rw-------  1 digoal  staff   730M May  5 17:34 base/14020/34126  
-rw-------  1 digoal  staff   200K May  5 17:34 base/14020/34126_fsm  
-rw-------  1 digoal  staff    24K May  5 17:34 base/14020/34126_vm  
  
  
删除测试表  
  
postgres=# drop table tbl;  
DROP TABLE  
  
查看被删除的表的数据文件是否已被清理  
  
IT-C02YW2EFLVDL:data14 digoal$ ll base/14020/34126*  
-rw-------  1 digoal  staff     0B May  5 17:35 base/14020/34126  
  
记录wal位置  
  
postgres=# select pg_current_wal_lsn();  
 pg_current_wal_lsn  
--------------------  
 1/A601F310  
(1 row)  
  
postgres=# checkpoint;  
CHECKPOINT  
postgres=# select pg_current_wal_lsn();  
 pg_current_wal_lsn  
--------------------  
 1/A601F3C0  
(1 row)  
  
计算drop操作带来的wal消耗, 很明显DROP操作都不会将该表的数据写入WAL. 包括TRUNCATE也一样.  
  
postgres=# select pg_size_pretty(pg_wal_lsn_diff('1/A601F3C0','1/A60000D8'));  
 pg_size_pretty  
----------------  
 125 kB  
(1 row)  
  
  
备份开始后, 会记录一个wal文件的位置, 意味着这个备份集需要有从这个时刻开始的所有WAL日志, 才能用于恢复.  
  
cd $PGDATA  
  
cat backup_label  
START WAL LOCATION: 1/A6000028 (file 0000000100000001000000A6)  
CHECKPOINT LOCATION: 1/A6000060  
BACKUP METHOD: pg_start_backup  
BACKUP FROM: primary  
START TIME: 2023-05-05 17:28:20 CST  
LABEL: abc  
START TIMELINE: 1  
  
  
停止备份, 意味着PITR的时间点对应的wal必须在这之后.  
  
postgres=# select pg_stop_backup();  
NOTICE:  WAL archiving is not enabled; you must ensure that all required WAL segments are copied through other means to complete the backup  
 pg_stop_backup  
----------------  
 1/A601F420  
(1 row)  
```  
  
所以:  
- PITR只能恢复到全量备份结束后的时刻.  
  
思考问题:  
- 为什么PG不考虑当前正在备份, 延迟删除数据文件呢? 这样的话, 备份开始时刻就可以成为PITR的选择时刻.  
  
  
  
3、为什么逻辑备份可能和业务产生冲突?  
https://www.bilibili.com/video/BV1Em4y1y7PV/  
  
逻辑备份pg_dump备份集是一致性备份集, 如果一个实例有多个database, 一致性最大范围可包含一个库.  
  
1 首先开启RR事务  
2 然后对需要备份的对象加共享锁, 防止要备份的数据被DROP或TRUNCATE, 或者结构被变更.  
过程2进行中, 和这些操作冲突, pg_dump getSchemaData() 操作被堵塞: (与DDL、vacuum full、cluser、ALTER 等操作冲突, 包括pg_repack在切换数据文件时也需要短暂的排他锁与之冲突.)  
过程2结束后, 过程3结束前, 和这些操作冲突, 用户操作被堵塞: (与DDL、vacuum full、cluser、ALTER 等操作冲突, 包括pg_repack在切换数据文件时也需要短暂的排他锁与之冲突.)  
3 依次备份数据, 直到完成, 释放共享锁.  
  
由于2到3的过程取决于备份集的大小, 如果备份集很大, 在这段时间冲突概率就会比较大.  
  
例如, 凌晨逻辑备份, 用户正好在凌晨执行vacuum full整理数据, 或者在凌晨有一些数据处理操作用到了DDL处理中间结果|表名等.  
  
  
PS: 多个库不保障一致性, 因为不支持跨库import snapshot.   也许未来的版本会支持.  
  
如果是单个库使用多个JOB并行备份时, 怎么保障多个JOB备份数据的全局一致性? 就是用的snapshot export功能.  
  
```  
postgres=# begin transaction isolation level repeatable read ;  
BEGIN  
postgres=*# select pg_export_snapshot();  
 pg_export_snapshot  
---------------------  
 00000004-00000227-1  
(1 row)  
  
.......  
  
db1=# begin TRANSACTION ISOLATION LEVEL repeatable read;  
BEGIN  
db1=*# SET TRANSACTION SNAPSHOT '00000004-00000227-1';  
ERROR:  cannot import a snapshot from a different database  
```  
  
  
pg_dump.c   // 开启RR 事务  
  
```  
        /*  
         * Start transaction-snapshot mode transaction to dump consistent data.  
         */  
        ExecuteSqlStatement(AH, "BEGIN");  
        if (AH->remoteVersion >= 90100)  
        {  
                /*  
                 * To support the combination of serializable_deferrable with the jobs  
                 * option we use REPEATABLE READ for the worker connections that are  
                 * passed a snapshot.  As long as the snapshot is acquired in a  
                 * SERIALIZABLE, READ ONLY, DEFERRABLE transaction, its use within a  
                 * REPEATABLE READ transaction provides the appropriate integrity  
                 * guarantees.  This is a kluge, but safe for back-patching.  
                 */  
                if (dopt->serializable_deferrable && AH->sync_snapshot_id == NULL)  
                        ExecuteSqlStatement(AH,  
                                                                "SET TRANSACTION ISOLATION LEVEL "  
                                                                "SERIALIZABLE, READ ONLY, DEFERRABLE");  
                else  
                        ExecuteSqlStatement(AH,  
                                                                "SET TRANSACTION ISOLATION LEVEL "  
                                                                "REPEATABLE READ, READ ONLY");  
        }  
```  
  
  
pg_dump.c     // 对表加共享锁  
  
```  
/*  
 * getTables  
 *        read all the tables (no indexes)  
 * in the system catalogs return them in the TableInfo* structure  
 *  
 * numTables is set to the number of tables read in  
 */  
TableInfo *  
getTables(Archive *fout, int *numTables)  
{  
.........  
  
        for (i = 0; i < ntups; i++)  
        {  
        .........  
  
                /*  
                 * Read-lock target tables to make sure they aren't DROPPED or altered  
                 * in schema before we get around to dumping them.  
                 *  
                 * Note that we don't explicitly lock parents of the target tables; we  
                 * assume our lock on the child is enough to prevent schema  
                 * alterations to parent tables.  
                 *  
                 * NOTE: it'd be kinda nice to lock other relations too, not only  
                 * plain or partitioned tables, but the backend doesn't presently  
                 * allow that.  
                 *  
                 * We only need to lock the table for certain components; see  
                 * pg_dump.h  
                 */  
                if (tblinfo[i].dobj.dump &&  
                        (tblinfo[i].relkind == RELKIND_RELATION ||  
                         tblinfo[i].relkind == RELKIND_PARTITIONED_TABLE) &&  
                        (tblinfo[i].dobj.dump & DUMP_COMPONENTS_REQUIRING_LOCK))  
                {  
                        resetPQExpBuffer(query);  
                        appendPQExpBuffer(query,  
                                                          "LOCK TABLE %s IN ACCESS SHARE MODE",  
                                                          fmtQualifiedDumpable(&tblinfo[i]));  
                        ExecuteSqlStatement(fout, query->data);  
                }  
  
                /* Emit notice if join for owner failed */  
                if (strlen(tblinfo[i].rolname) == 0)  
                        pg_log_warning("owner of table \"%s\" appears to be invalid",  
                                                   tblinfo[i].dobj.name);  
```  
  
  
pg_dump.h    // 判断表的哪些元数据需要加共享锁  
  
```  
/* component types of an object which can be selected for dumping */  
typedef uint32 DumpComponents;  /* a bitmask of dump object components */  
#define DUMP_COMPONENT_NONE                     (0)  
#define DUMP_COMPONENT_DEFINITION       (1 << 0)  
#define DUMP_COMPONENT_DATA                     (1 << 1)  
#define DUMP_COMPONENT_COMMENT          (1 << 2)  
#define DUMP_COMPONENT_SECLABEL         (1 << 3)  
#define DUMP_COMPONENT_ACL                      (1 << 4)  
#define DUMP_COMPONENT_POLICY           (1 << 5)  
#define DUMP_COMPONENT_USERMAP          (1 << 6)  
#define DUMP_COMPONENT_ALL                      (0xFFFF)  
  
/*  
 * component types which require us to obtain a lock on the table  
 *  
 * Note that some components only require looking at the information  
 * in the pg_catalog tables and, for those components, we do not need  
 * to lock the table.  Be careful here though- some components use  
 * server-side functions which pull the latest information from  
 * SysCache and in those cases we *do* need to lock the table.  
 *  
 * We do not need locks for the COMMENT and SECLABEL components as  
 * those simply query their associated tables without using any  
 * server-side functions.  We do not need locks for the ACL component  
 * as we pull that information from pg_class without using any  
 * server-side functions that use SysCache.  The USERMAP component  
 * is only relevant for FOREIGN SERVERs and not tables, so no sense  
 * locking a table for that either (that can happen if we are going  
 * to dump "ALL" components for a table).  
 *  
 * We DO need locks for DEFINITION, due to various server-side  
 * functions that are used and POLICY due to pg_get_expr().  We set  
 * this up to grab the lock except in the cases we know to be safe.  
 */  
#define DUMP_COMPONENTS_REQUIRING_LOCK (\  
                DUMP_COMPONENT_DEFINITION |\  
                DUMP_COMPONENT_DATA |\  
                DUMP_COMPONENT_POLICY)  
```  
  
  
  
4、为什么逻辑备份可能导致实例膨胀?  
https://www.bilibili.com/video/BV1Z14y1Z7nm/   
  
这和垃圾回收的机制有关, 最早的XID之后产生的垃圾tuple, 都不会被回收.  
  
逻辑备份会开启一个RR事务, 备份持续时间越久, 不可被回收的垃圾堆积的概率就越大. 所以越有可能膨胀.  
  
例如备份持续了5个小时, 这5个小时里面有10亿条记录被update或delete, 那么这些垃圾tuple都不能在备份结束前被回收, 导致碰撞.  
  
[《PostgreSQL垃圾回收代码分析 - why postgresql cann't reclaim tuple is HEAPTUPLE_RECENTLY_DEAD》](../201505/20150503_01.md)  
  
[《PostgreSQL 实时健康监控 大屏 - 高频指标 - 珍藏级》](../201806/20180613_02.md)  
  
[《PostgreSQL DBA最常用SQL》](../202005/20200509_02.md)  
  
```  
-- 膨胀点查询  
select * from (
select datname,usename,least(xact_start, query_start) as least_start,  
greatest(age(backend_xid), age(backend_xmin)) as greatest_age,  
now()-least(xact_start, query_start) as old_ts, 
query  
from pg_stat_activity  
where ltrim(lower(query),' ') !~ '^vacuum'  
and not (query ~ 'autovacuum' and backend_type <> 'client backend')  
and pid <> pg_backend_pid()  
order by greatest(age(backend_xid), age(backend_xmin)) desc nulls last limit 1  
) t1 
union all 
select * from (
select database,owner,prepared,age(transaction),now()-prepared,'2pc xact: '||gid from pg_prepared_xacts
order by age(transaction) desc nulls last limit 1 
) t2 ;
```  
  
膨胀点监测 - 多久以前的垃圾可以被回收  
  
时间间隔越大，说明越容易导致膨胀。  
  
排查这几个方向，长事务，长SQL，2PC，持有SNAPSHOT的QUERY。必要时把不合理的老的会话干掉。  
  
```  
with a as  
(select min(xact_start) m from pg_stat_activity where backend_xid is not null or backend_xmin is not null),  
b as (select min(prepared) m from pg_prepared_xacts)  
select now()-least(a.m,b.m) from a,b;  
```  
  
  
另外再补充10个chatGPT总结的10个热门问题:  
  
#### PostgreSQL用户最关心的“数据备份、数据恢复、逻辑订阅”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
5、如何进行PostgreSQL数据库的完整备份和增量备份？  
- 用户特别关心这个问题是因为备份是保证数据安全和可靠性的基础，而全量备份和增量备份可以让用户在备份时间和存储空间上做出更好的平衡，从而确保备份的高效和经济性。用户需要掌握完整备份和增量备份的概念，以及如何使用PostgreSQL自带工具进行备份。  
   
https://www.bilibili.com/video/BV1mP411178U/    
  
方法1   
```  
wal_level>=replica  
enable archiver  
  
全量备份  
pg_start_backup  
copy pgdata+tbs dir  
pg_stop_backup  
  
增量备份  
pg_start_backup 到 pg_stop_backup 之间的所有wal  
以及pg_stop_backup之后的所有wal.  
```  
  
方法2  
```  
全量+WAL备份  
pg_basebackup  
  
增量备份  
归档日志  
```  
  
方法3  
- [《如何创建RDS PG 的秒级 flashback闪回实例, 实时容灾实例 - zfs - snapshot - clone - standby - compress》](../202003/20200321_02.md)    
- [《PostgreSQL 最佳实践 - 块级增量备份(ZFS篇)验证 - recovery test script for zfs snapshot clone + postgresql stream replication + archive》](../201608/20160823_09.md)    
- [《PostgreSQL 最佳实践 - 块级增量备份(ZFS篇)双机HA与块级备份部署》](../201608/20160823_08.md)    
- [《PostgreSQL 最佳实践 - 块级增量备份(ZFS篇)单个数据库采用多个zfs卷(如表空间)时如何一致性备份》](../201608/20160823_07.md)    
- [《PostgreSQL 最佳实践 - 块级增量备份(ZFS篇)备份集有效性自动校验》](../201608/20160823_06.md)    
- [《PostgreSQL 最佳实践 - 块级增量备份(ZFS篇)方案与实战》](../201608/20160823_05.md)    
  
方法4  
- [《PostgreSQL ptrack , pg_rman , 块级增量备份》](../202003/20200326_14.md)    
- [《PostgreSQL 最佳实践 - 块级别增量备份(pg_rman baseon LSN)源码浅析与使用》](../201608/20160826_01.md)    
- [《PostgreSQL 最佳实践 - pg_rman 以standby为源的备份浅析》](../201608/20160829_02.md)    
- [《PostgreSQL 最佳实践 - pg_rman 数据库恢复示例 与 软件限制解说》](../201608/20160829_03.md)
- PG 17版本开始支持块级增量备份. [《PostgreSQL 17 preview - 内置块级别物理增量备份(INCREMENTAL backup/pg_combinebackup)功能》](../202312/20231222_01.md)  
  
  
6、如何使用pg_dump命令备份PostgreSQL数据库？  
- 用户特别关心这个问题是因为pg_dump是PostgreSQL数据库备份的标准工具，用户需要掌握其使用方法以确保备份的准确性和完整性，同时也方便恢复数据时的操作。用户需要了解pg_dump的命令行参数和使用场景，以及如何进行自动备份。  
  
7、如何使用pg_restore命令恢复PostgreSQL数据库？  
- 用户特别关心这个问题是因为pg_restore是恢复备份数据的工具，用户需要掌握其使用方法以便于快速恢复数据，同时也确保恢复的准确性和完整性。用户需要了解pg_restore的命令行参数和使用场景，以及如何在恢复过程中避免数据丢失或损坏。  
   
https://www.bilibili.com/video/BV1wg4y1L7Nv/   
  
- 全局信息: 用户、表空间  
- 定义  
- 数据及格式  
- 权限  
- 表空间  
- 白名单|黑名单  
- 备份并行度  
  
https://www.postgresql.org/docs/current/app-pg-dumpall.html  
  
https://www.postgresql.org/docs/current/app-pgdump.html  
  
  
重点了解一下TOC  
- [《PostgreSQL Logical Backup's TOC File》](../201204/20120412_01.md)    
  
https://www.postgresql.org/docs/current/app-pgrestore.html  
  
  
  
8、如何将PostgreSQL备份文件还原到不同的数据库名称或服务器上？  
- 用户特别关心这个问题是因为在数据迁移或灾备恢复等场景下，用户需要将备份数据还原到不同的数据库或服务器上。用户需要了解如何修改备份文件中的数据库名称和服务器地址，以及在还原过程中需要注意的事项。  
  
9、如何自动备份PostgreSQL数据库并将备份文件上传到云存储？  
- 用户特别关心这个问题是因为自动备份可以减轻用户的工作负担，同时将备份文件上传到云存储可以保证备份数据的高可用性和安全性。用户需要了解如何使用定时任务或脚本来实现自动备份，以及如何将备份文件上传到云存储平台。  
  
  
请接着返回6-10的问题.  
  
10、如何订阅PostgreSQL数据库的备份通知并及时获取备份状态？  
- 用户特别关心这个问题是因为备份通知可以让用户及时了解备份状态，及时发现备份异常或失败，从而保证备份的及时性和有效性。用户需要了解如何设置备份通知，并如何使用邮件或短信来及时获取备份状态。  
  
11、如何使用PostgreSQL的物理备份功能进行备份和恢复？  
- 用户特别关心这个问题是因为物理备份可以提供更高效的备份和恢复方式，用户需要掌握其使用方法以确保备份和恢复的快速和可靠。用户需要了解如何使用pg_basebackup命令进行物理备份和如何使用restore_command选项进行物理恢复。  
  
12、如何备份和恢复PostgreSQL数据库中的特定表或数据？  
- 用户特别关心这个问题是因为在某些场景下，用户只需要备份或恢复特定表或数据，这时需要掌握相关的备份和恢复技术以保证备份和恢复的准确性和有效性。用户需要了解如何使用pg_dump和pg_restore命令来备份和恢复特定表或数据。  
  
13、如何在备份和恢复过程中避免数据丢失或损坏？  
- 用户特别关心这个问题是因为备份和恢复过程中可能会出现数据丢失或损坏的情况，用户需要掌握相关的备份和恢复技术以确保备份和恢复的数据完整性和安全性。用户需要了解如何使用事务和日志来保证数据的一致性和可靠性，同时也需要了解如何进行备份和恢复测试。  
  
14、如何进行PostgreSQL数据库的逻辑订阅？  
- 用户特别关心这个问题是因为逻辑订阅可以实现数据同步和分布式部署，用户需要掌握其使用方法以确保数据的高效和可靠。用户需要了解如何设置逻辑订阅和如何处理订阅过程中可能出现的异常情况。  
  
  
  
### 从库  
  
1、为什么在从库上跑长事务或长SQL可能会报错?  
  
2、为什么从库会出现回放延迟?  
  
3、为什么主备切换后并不总是需要重建HA或重建灾难备份库?  
  
4、为什么有时从库会报上游WAL日志已删除的错误?  
  
#### PostgreSQL用户最关心的“从库”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
5、从库的同步延迟  
- 用户特别关心从库的同步延迟问题，因为这会影响到数据的一致性和可靠性。如果从库的同步延迟过大，可能会导致主库和从库之间的数据不一致，从而影响应用程序的正常运行。  
  
6、从库的性能优化  
- 用户特别关心从库的性能优化问题，因为从库需要承担大量的读请求，而且需要保证数据的一致性和可靠性。用户需要通过各种手段，如索引优化、查询优化、参数优化等来提高从库的性能，以满足业务需求。  
  
7、从库的备份和恢复  
- 用户特别关心从库的备份和恢复问题，因为这会影响到数据的安全性和可靠性。用户需要定期备份从库数据，并且能够快速地进行恢复，以应对各种意外情况，如硬件故障、数据损坏等。  
  
8、从库的故障处理  
- 用户特别关心从库的故障处理问题，因为从库的故障会影响到整个系统的可用性和性能。用户需要及时发现和解决从库的故障，并且能够进行合理的故障处理，以保证系统的稳定性和可靠性。  
  
9、从库的容灾和高可用  
- 用户特别关心从库的容灾和高可用问题，因为这可以保证系统的可靠性和稳定性。用户需要通过各种手段，如冗余部署、负载均衡、云备份等来保证从库的容灾和高可用，以应对各种意外情况，如硬件故障、网络故障等。  
  
请接着返回6-10的问题.  
  
10、从库的版本升级和迁移  
- 用户特别关心从库的版本升级和迁移问题，因为这涉及到数据库的稳定性和兼容性。用户需要选择合适的版本升级和迁移方案，避免数据丢失和系统不稳定。  
  
11、从库的安全性  
- 用户特别关心从库的安全性问题，因为从库存储了敏感数据，如果安全措施不到位，可能会导致数据泄露和安全风险。用户需要采取各种措施，如访问控制、加密、审计等来确保从库的安全性。  
  
12、从库的监控和管理  
- 用户特别关心从库的监控和管理问题，因为这可以帮助用户及时发现和解决问题，确保系统的正常运行。用户需要通过各种监控工具和系统管理工具，对从库进行实时监控和管理。  
  
13、从库的数据一致性检测  
- 用户特别关心从库的数据一致性问题，因为数据一致性是数据库的核心功能之一。用户需要定期对从库的数据进行一致性检测，避免数据不一致的情况发生。  
  
14、从库的容量规划和扩展  
- 用户特别关心从库的容量规划和扩展问题，因为数据量的增长可能会导致从库容量不足。用户需要通过合理的容量规划和扩展方案来保证从库的容量足够，并且能够适应数据量的增长。  
  
  
### 性能、管理  
  
1、为什么默认配置性能比较差?  
  
2、为什么要关闭NUMA?  
  
3、为什么高并发的短链接性能会很差?  
  
4、为什么会发生OOM?         (adj 防止 https://github.com/digoal/blog/blob/master/201801/20180121_01.md)  
  
5、为什么存在内存浪费严重的现象?   (relcache, 分区表, 内存霸占, 未开启huge page页表浪费)  
  
6、为什么在操作系统直接kill 数据库进程会导致数据库重启?  
  
7、为什么会出现数据库块损坏?  
  
8、为什么存在与业务无关的突发IO和CPU飙升?  
  
9、为什么存在与业务无关的持续IO与CPU消耗?  
  
10、为什么表会膨胀?            (https://github.com/digoal/blog/blob/master/201801/20180121_01.md)  
```  
回收不及时:  
产生垃圾速度太快  
存储性能太差(RT高) [《一起学PolarDB - 第23期 - 为什么磁盘RT会严重影响vacuum垃圾回收效率?》](../202202/20220216_01.md)  
内存设置问题, 索引多次扫描  
参数设置问题, 回收太懒  
non removeable tuple  
  
各自应对策略  
SSD性能, 降低RT  
其他调参数  
```  
  
11、为什么索引会膨胀?  
  
12、为什么垃圾回收有时不起作用?  
```  
为什么有nonremoveable tuple  
快照旧  
2pc  
feedback 从库旧快照  
强制延迟回收  
slot 影响catalog回收  
```  
  
13、为什么log日志量暴增而且影响性能?  (审计, pipeline buffer, 使用采样日志)  
  
14、为什么WAL日志会堆积?       (https://github.com/digoal/blog/blob/master/201801/20180121_01.md)  
  
15、为什么WAL会突然暴增?  
  
16、为什么数据文件会突然暴增?      (递归死循环、某些大的查询可能导致临时文件的大量产生  https://github.com/digoal/blog/blob/master/201801/20180121_01.md)  
  
17、为什么会出现雪崩?  
  
18、为什么大量delete后表和索引的空间没有变小?   (高水位)  
  
19、如何在线降低表、索引水位?  
  
20、为什么push|pull大量数据的读写比较慢?     (COPY, pipeline模式)  
  
21、怎么判断数据库有没有瓶颈?  (处理能力有没有到顶? 还能支撑多大的业务增长?)  
  
22、如何发现过去、现在、未来的性能问题?  
  
23、为什么SQL执行计划不正确?  
  
24、为什么WAL日志文件不能随便删除?  
  
25、为什么明明索引更快却不用索引或者明明index更快却使用bitmap?  random page cost.  
  
26、为什么需要bitmap scan?  
  
27、为什么index scan扫描了很多很多个block?  
  
28、为什么order by 扫描了很多很多个block?  
- enable_sort off  
  
#### PostgreSQL用户最关心的“数据库性能优化”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
29、查询优化  
- 用户特别关心查询优化问题，因为查询是数据库的核心功能之一，也是应用程序性能的瓶颈之一。通过合理的查询优化，可以提高查询的效率和性能，从而提升整个系统的性能。  
  
30、索引优化  
- 用户特别关心索引优化问题，因为索引可以提高数据库的查询效率和性能。用户需要选择合适的索引类型，并进行合理的索引配置和管理，以最大化索引的效果。  
  
31、锁优化  
- 用户特别关心锁优化问题，因为并发访问是数据库的常见场景之一，而锁机制是保证数据一致性的核心机制之一。通过合理的锁优化，可以提高数据库的并发性能和效率。  
  
32、事务优化  
- 用户特别关心事务优化问题，因为事务是数据库的核心功能之一，而事务机制是保证数据一致性的核心机制之一。通过合理的事务优化，可以提高数据库的并发性能和效率。  
  
33、连接池优化  
- 用户特别关心连接池优化问题，因为连接池是数据库应用程序的常见组件之一。通过合理的连接池优化，可以提高应用程序的性能和效率，从而提升整个系统的性能。  
  
请接着返回6-10的问题.  
  
34、参数优化  
- 用户特别关心参数优化问题，因为数据库有很多可配置参数，而这些参数的设置和调整会直接影响数据库的性能和效率。通过合理的参数优化，可以提高数据库的性能和效率，从而提升整个系统的性能。  
  
35、内存优化  
- 用户特别关心内存优化问题，因为内存是数据库的核心资源之一，而数据库的性能和效率直接受制于内存的使用情况。通过合理的内存优化，可以提高数据库的性能和效率。  
  
36、IO优化  
- 用户特别关心IO优化问题，因为数据库的IO操作是数据库性能的一个重要因素。通过合理的IO优化，可以提高数据库的性能和效率。  
  
37、网络优化  
- 用户特别关心网络优化问题，因为网络是数据库应用程序和数据库服务器之间的关键组件之一。通过合理的网络优化，可以提高应用程序和数据库之间的通信效率和速度，从而提高整个系统的性能和效率。  
  
38、统计信息优化  
- 用户特别关心统计信息优化问题，因为统计信息可以帮助数据库优化查询计划，提高数据库的查询性能和效率。通过合理的统计信息优化，可以提高数据库的性能和效率。  
  
#### PostgreSQL用户最关心的“数据库管理”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
39、如何进行备份和恢复?  
- PostgreSQL用户非常关心备份和恢复，因为备份和恢复是保护数据的最重要手段之一。用户通常关心备份和恢复的速度、可靠性和成本等问题，并使用不同的备份策略和恢复方法来满足不同的需求。  
  
40、如何进行性能优化?  
- PostgreSQL用户非常关心性能优化，因为性能是数据库管理的核心问题之一。用户通常关心查询优化、索引优化、缓存优化和查询调优等问题，并使用不同的技��手段来提高数据库的性能。  
  
41、如何进行监控和诊断?  
- PostgreSQL用户非常关心监控和诊断，因为监控和诊断是维护数据库健康的重要手段之一。用户通常关心监控的粒度、诊断的准确性和诊断的速度等问题，并使用不同的监控和诊断工具来满足不同的需求。  
  
42、如何进行升级和迁移?  
- PostgreSQL用户非常关心升级和迁移，因为升级和迁移是数据库管理中不可避免的任务之一。用户通常关心升级和迁移的步骤、风险和时间成本等问题，并使用不同的升级和迁移策略来满足不同的需求。  
  
43、如何进行容量规划?  
- PostgreSQL用户非常关心容量规划，因为容量规划是数据库管理中的关键任务之一。用户通常关心容量规划的精度、方法和未来扩展的可能性等问题，并使用不同的容量规划方法来满足不同的需求。  
  
请接着返回6-10的问题.  
  
44、如何进行安全管理?  
- PostgreSQL用户非常关心安全管理，因为安全管理是数据库管理中至关重要的任务之一。用户通常关心访问控制、敏感数据的保护、加密和审计等问题，并使用不同的安全管理策略来保护数据库的安全。  
  
45、如何进行版本控制?  
- PostgreSQL用户非常关心版本控制，因为版本控制是数据库管理中的关键任务之一。用户通常关心版本控制的精度、版本管理的方法、版本回滚的策略等问题，并使用不同的版本控制工具来满足不同的需求。  
  
46、如何进行数据清理?  
- PostgreSQL用户非常关心数据清理，因为数据清理是数据库管理中的关键任务之一。用户通常关心数据清理的周期、方法和清理数据的策略等问题，并使用不同的数据清理工具和策略来满足不同的需求。  
  
47、如何进行数据备份和恢复测试?  
- PostgreSQL用户非常关心数据备份和恢复测试，因为备份和恢复测试是确保备份和恢复流程有效的重要手段之一。用户通常关心备份和恢复测试的频率、测试的精度和测试的成本等问题，并使用不同的测试方法来确保备份和恢复流程的有效性。  
  
48、如何进行数据库文档化?  
- PostgreSQL用户非常关心数据库文档化，因为数据库文档化是数据库管理中的关键任务之一。用户通常关心文档化的深度、广度和文档化的方法等问题，并使用不同的文档化工具和策略来满足不同的需求。  
  
#### PostgreSQL用户最关心的“数据管理”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
49、数据的备份和恢复  
- 用户特别关心数据的备份和恢复问题，因为数据是企业的重要资产，如果数据丢失或者损坏，可能会对企业造成重大损失。用户需要定期备份数据，并且能够快速地进行恢复，以应对各种意外情况，如硬件故障、数据损坏等。  
  
50、数据的安全性  
- 用户特别关心数据的安全性问题，因为数据存储了企业的机密信息，如果安全措施不到位，可能会导致数据泄露和安全风险。用户需要采取各种措施，如加密、访问控制、审计等来确保数据的安全性。  
  
51、数据的质量管理  
- 用户特别关心数据的质量管理问题，因为数据质量直接影响到企业的业务效率和决策效果。用户需要通过各种手段，如数据清洗、数据校验、数据整合等来提高数据的质量，以提升企业的业务效率和决策效果。  
  
52、数据的备份恢复策略  
- 用户特别关心数据的备份恢复策略问题，因为备份恢复是保证数据安全和可靠的重要手段之一。用户需要制定合理的备份恢复策略，并进行定期的演练和优化，以保证备份恢复的可靠性和有效性。  
  
53、数据的归档和压缩  
- 用户特别关心数据的归档和压缩问题，因为数据量不断增长，需要进行合理的归档和压缩，以提高数据的管理效率和存储效率。用户需要选择合适的数据归档和压缩方案，并进行合理的配置和管理，以保证数据的可靠性和存储效率。  
  
请接着返回6-10的问题.  
  
54、数据的同步和复制  
- 用户特别关心数据的同步和复制问题，因为数据需要在不同的地方或者系统中进行共享和使用。用户需要选择合适的数据同步和复制方案，并进行合理的配置和管理，以保证数据的一致性和可靠性。  
  
55、数据的分区和分片  
- 用户特别关心数据的分区和分片问题，因为随着数据量的不断增长，需要进行合理的数据分区和分片，以提高数据的管理效率和存储效率。用户需要选择合适的数据分区和分片方案，并进行合理的配置和管理，以保证数据的可靠性和存储效率。  
  
56、数据库的数据迁移  
- 用户特别关心数据库的数据迁移问题，因为随着业务的变化，数据库需要进行数据迁移，以满足业务需求。用户需要选择合适的数据迁移方案，并进行合理的配置和管理，以保证数据的可靠性和迁移效率。  
  
57、数据库的数据清理  
- 用户特别关心数据库的数据清理问题，因为随着数据量的不断增长，数据库中可能存在很多不再使用的数据，需要进行定期的数据清理。用户需要选择合适的数据清理方案，并进行合理的配置和管理，以提高数据库的管理效率和存储效率。  
  
58、数据库的数据备份和迁移格式  
- 用户特别关心数据库的数据备份和迁移格式问题，因为不同的备份和迁移格式可能会影响备份和迁移的效率和可靠性。用户需要选择合适的备份和迁移格式，并进行合理的配置和管理，以保证备份和迁移的效率和可靠性。  
  
  
### 业务  
1、为什么时序类搜索可能有IO放大，除了 cpu,io,net 还有哪些隐藏的瓶颈，为什么要聚集?  
  
2、为什么空间搜索有IO放大，为什么要数据聚集， 为什么要分裂查询?  
  
3、为什么有时索引扫描并不比全表扫描更快?  
  
4、为什么GIN有时不快?  
  
5、为什么BRIN有时不快?  
  
6、为什么输入顺序会影响最终GiST创建出来的索引性能?  
  
7、有几种索引、该如何选择索引?  
  
8、为什么当前还不建议频繁使用临时表?  
  
#### PostgreSQL用户最关心的“数据类型和应用场景”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
9、PostgreSQL支持哪些数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL支持哪些数据类型，以及这些数据类型适用于哪些业务场景，因为数据类型直接影响到数据库的数据存储和检索，而不同的业务场景需要不同的数据类型。例如，PostgreSQL支持的数值型适用于计算型业务场景，而字符型适用于文本型业务场景。  
  
10、PostgreSQL如何支持JSON和JSONB数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持JSON和JSONB数据类型，以及这些数据类型适用于哪些业务场景，因为JSON和JSONB是现代应用程序中常用的数据格式之一，可以方便地存储和查询复杂的结构化数据。例如，JSON和JSONB适用于日志分析、数据挖掘等业务场景。  
  
11、PostgreSQL如何支持数组和范围数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持数组和范围数据类型，以及这些数据类型适用于哪些业务场景，因为数组和范围是现代应用程序中常用的数据类型之一，可以方便地进行数据处理和分析。例如，数组和范围适用于统计分析、数据挖掘、时间序列等业务场景。  
  
12、PostgreSQL如何支持GIS数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持GIS数据类型，以及这些数据类型适用于哪些业务场景，因为GIS数据类型是现代应用程序中常用的数据类型之一，可以方便地进行地理信息分析和查询。例如，GIS数据类型适用于地图制作、城市规划、环境监测等业务场景。  
  
13、PostgreSQL如何支持全文搜索和文本查询？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持全文搜索和文本查询，以及这些功能适用于哪些业务场景，因为全文搜索和文本查询是现代应用程序中常用的功能之一，可以方便地进行文本搜索和分析。例如，全文搜索和文本查询适用于新闻聚合、搜索引擎、社交媒体等业务场景。  
  
请接着返回6-10的问题.  
  
14、PostgreSQL如何支持时间序列数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持时间序列数据类型，以及这些数据类型适用于哪些业务场景，因为时间序列是现代应用程序中常用的数据类型之一，可以方便地进行时间序列分析和查询。例如，时间序列数据类型适用于物联网、金融行业、能源行业等业务场景。  
  
15、PostgreSQL如何支持音视频数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持音视频数据类型，以及这些数据类型适用于哪些业务场景，因为音视频数据类型是现代应用程序中常用的数据类型之一，可以方便地进行音视频数据处理和分析。例如，音视频数据类型适用于多媒体平台、视频监控、智能家居等业务场景。  
  
16、PostgreSQL如何支持加密数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持加密数据类型，以及这些数据类型适用于哪些业务场景，因为加密数据类型是现代应用程序中常用的数据类型之一，可以方便地进行数据加密和解密。例如，加密数据类型适用于银行、保险、医疗等业务场景。  
  
17、PostgreSQL如何支持数据压缩和解压缩？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持数据压缩和解压缩，以及这些功能适用于哪些业务场景，因为数据压缩和解压缩可以提高数据库的性能和效率。例如，数据压缩和解压缩适用于大数据存储、备份恢复、数据传输等业务场景。  
  
18、PostgreSQL如何支持自定义数据类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL如何支持自定义数据类型，以及这些数据类型适用于哪些业务场景，因为自定义数据类型可以根据业务需求进行定制化设计。例如，自定义数据类型适用于特定行业或业务领域中的数据存储和处理需求。  
  
#### PostgreSQL用户最关心的“索引”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
19、PostgreSQL支持哪些索引类型？适用于哪些业务场景？  
- 用户特别关心PostgreSQL支持哪些索引类型，以及这些索引类型适用于哪些业务场景，因为索引是数据库中优化查询性能的重要手段之一。例如，B树索引适用于范围查询和排序，而哈希索引适用于等值查询。  
  
20、PostgreSQL如何创建和管理索引？  
- 用户特别关心如何创建和管理索引，因为索引的创建和管理直接影响到数据库的性能和效率。PostgreSQL提供了多种方式来创建和管理索引，如CREATE INDEX语句、pgAdmin工具等。  
  
21、PostgreSQL如何优化查询性能？  
- 用户特别关心如何优化查询性能，因为查询性能直接影响到数据库应用的用户体验和效率。PostgreSQL可以通过多种方式来优化查询性能，如索引优化、查询重写、参数优化等。  
  
22、PostgreSQL的B树索引和B树索引的优化有哪些？  
- 用户特别关心PostgreSQL的B树索引和B树索引的优化，因为B树索引是PostgreSQL中最常用的索引类型之一，可以提高PostgreSQL的查询性能和效率。B树索引的优化包括索引列的选择、索引的覆盖性、索引的合并和分裂等。  
  
23、PostgreSQL的哈希索引和哈希索引的优化有哪些？  
- 用户特别关心PostgreSQL的哈希索引和哈希索引的优化，因为哈希索引在一些业务场景中可以提高PostgreSQL的查询性能和效率。哈希索引的优化包括哈希函数的选择、哈希桶的大小、哈希冲突的解决等。  
  
请接着返回6-10的问题.  
  
24、PostgreSQL如何支持全文搜索和文本索引？  
- 用户特别关心PostgreSQL如何支持全文搜索和文本索引，以及这些功能适用于哪些业务场景，因为全文搜索和文本索引是现代应用程序中常用的功能之一，可以方便地进行文本搜索和分析。PostgreSQL支持的文本索引类型包括全文搜索、trigram索引等。  
  
25、PostgreSQL如何支持空间索引和空间数据类型？  
- 用户特别关心PostgreSQL如何支持空间索引和空间数据类型，以及这些功能适用于哪些业务场景，因为空间索引和空间数据类型是现代应用程序中常用的功能之一，可以方便地进行地理信息分析和查询。PostgreSQL支持的空间索引类型包括GiST索引、SP-GiST索引等。  
  
26、PostgreSQL如何支持多列索引和联合索引？  
- 用户特别关心PostgreSQL如何支持多列索引和联合索引，以及这些功能适用于哪些业务场景，因为多列索引和联合索引可以提高PostgreSQL的查询性能和效率。例如，多列索引和联合索引适用于复杂的查询和数据分析场景。  
  
27、PostgreSQL如何使用索引加速JOIN操作？  
- 用户特别关心PostgreSQL如何使用索引加速JOIN操作，因为JOIN操作是PostgreSQL中常用的查询操作之一，而索引可以提高JOIN操作的查询性能和效率。PostgreSQL可以通过使用JOIN时的ON子句中的索引来加速JOIN操作。  
  
28、PostgreSQL如何使用索引加速子查询和分组操作？  
- 用户特别关心PostgreSQL如何使用索引加速子查询和分组操作，因为子查询和分组操作是PostgreSQL中常用的查询操作之一，而索引可以提高这些操作的查询性能和效率。PostgreSQL可以通过优化子查询和分组操作中的索引来加速查询。  
  
#### PostgreSQL用户最关心的“插件”有哪10个? 请按每个插件分别说明用户为什么特别关心这些插件? 先返回1-5.  
  
29、PostGIS插件  
- PostGIS插件是PostgreSQL中最流行的空间数据库扩展之一，支持地理信息系统和地理空间数据的存储和查询。用户特别关心PostGIS插件，因为它可以扩展PostgreSQL的功能和性能，使PostgreSQL成为一个强大的地理信息系统和空间数据库。  
  
30、PL/Python插件  
- PL/Python插件是PostgreSQL中最常用的扩展之一，它允许用户使用Python编写存储过程和函数。用户特别关心PL/Python插件，因为Python是一种广泛使用的编程语言，可以方便地进行数据分析和处理。  
  
31、TimescaleDB插件  
- TimescaleDB插件是PostgreSQL中一个快速、可扩展的时序数据库扩展，支持高性能的时序数据存储和查询。用户特别关心TimescaleDB插件，因为时序数据在现代应用程序中越来越普遍，而TimescaleDB插件可以提高PostgreSQL在时序数据场景中的适用性。  
  
32、pgAdmin插件  
- pgAdmin插件是PostgreSQL中最常用的管理工具之一，可以方便地进行数据库的管理和监控。用户特别关心pgAdmin插件，因为它可以提高PostgreSQL的管理效率和可靠性。  
  
33、citus插件  
- citus插件是一个分布式数据库扩展，可以将PostgreSQL分布在多个节点上，并提供分布式查询和分布式事务。用户特别关心citus插件，因为分布式数据库在现代应用程序中越来越普遍，而citus插件可以提高PostgreSQL在分布式场景中的适用性。  
  
请接着返回6-10.  
  
34、Postgres-XL插件  
- Postgres-XL插件也是一个分布式数据库扩展，可以将PostgreSQL分布在多个节点上，并提供分布式查询和分布式事务。Postgres-XL插件和citus插件相比，它更适用于高并发读写的场景，支持更多的SQL功能。  
  
35、pgBouncer插件  
- pgBouncer插件是PostgreSQL的连接池，可以提高PostgreSQL的连接效率和性能，并减少PostgreSQL的资源消耗。用户特别关心pgBouncer插件，因为连接池是现代应用程序中常用的功能之一，可以提高应用程序的性能和可靠性。  
  
36、pg_cron插件  
- pg_cron插件是PostgreSQL的定时任务扩展，可以方便地进行定时任务的管理和调度。用户特别关心pg_cron插件，因为定时任务是现代应用程序中常用的功能之一，可以方便地进行数据清理和数据分析等操作。  
  
37、pg_repack插件  
- pg_repack插件是PostgreSQL的表重组扩展，可以优化PostgreSQL的表结构并减少表的碎片。用户特别关心pg_repack插件，因为表重组是优化PostgreSQL性能和减少空间消耗的常用方法之一。  
  
38、Powa插件  
- Powa插件是PostgreSQL的性能监控扩展，可以提供详细的性能指标和监控信息。用户特别关心Powa插件，因为性能监控是优化PostgreSQL性能和提高应用程序可靠性的常用方法之一。  
  
  
### 安全  
1、为什么会有SQL注入?  
  
2、为什么赋予了select权限依旧无权查询表? (逻辑结构)  
- 怎么赋予默认只读权限  
- 怎么赋予默认写权限  
- 怎么赋予新增表的默认权限  
- 怎么赋予已有表的默认权限  
  
3、为什么事务号会耗尽?  
  
4、为什么慢SQL，空闲事务，长事务，2PC，慢SLOT，standby feedback，强制vacuum age defer都存在风险  
  
#### PostgreSQL用户最关心的“安全”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
5、如何确保数据的机密性?  
- PostgreSQL用户非常关心数据的机密性，因为数据泄露会对企业造成巨大的损失，包括财务损失、信誉受损等。用户通常使用加密算法、访问控制和审计等技术手段来确保数据的机密性。  
  
6、如何确保数据的完整性?  
- PostgreSQL用户非常关心数据的完整性，因为数据的篡改和损坏会对企业造成严重影响。用户通常使用完整性约束、事务和备份等技术手段来确保数据的完整性。  
  
7、如何确保数据的可用性?  
- PostgreSQL用户非常关心数据的可用性，因为数据的丢失和不可用会对企业造成灾难性的后果。用户通常使用高可用性和灾难恢复等技术手段来确保数据的可用性。  
  
8、如何防止SQL注入攻击?  
- PostgreSQL用户非常关心SQL注入攻击，因为SQL注入攻击是最常见的安全漏洞之一，可以导致数据泄露和损坏。用户通常使用参数化查询、存储过程和视图等技术手段来防止SQL注入攻击。  
  
9、如何防止跨站脚本攻击?  
- PostgreSQL用户非常关心跨站脚本攻击，因为跨站脚本攻击可以导致数据泄露和损坏。用户通常使用输入验证、输出编码和安全的JavaScript库等技术手段来防止跨站脚本攻击。  
  
请接着返回6-10的问题.  
  
10、如何防止密码被盗用?  
- PostgreSQL用户非常关心密码的安全性，因为密码是访问和操纵数据的重要凭证。用户通常使用强密码策略、密码哈希和密码加密等技术手段来防止密码被盗用。  
  
11、如何确保应用程序的安全性?  
- PostgreSQL用户非常关心应用程序的安全性，因为应用程序是访问和操纵数据的主要途径。用户通常使用网络安全、身份认证和访问控制等技术手段来确保应用程序的安全性。  
  
12、如何确保数据库服务器的安全性?  
- PostgreSQL用户非常关心数据库服务器的安全性，因为数据库服务器是存储和处理数据的核心。用户通常使用防火墙、入侵检测和安全更新等技术手段来确保数据库服务器的安全性。  
  
13、如何进行安全备份和恢复?  
- PostgreSQL用户非常关心安全备份和恢复，因为备份和恢复是保护数据的最重要手段之一。用户通常使用备份和恢复策略、加密备份和灾难恢复等技术手段来进行安全备份和恢复。  
  
14、如何处理数据泄露和安全漏洞?  
- PostgreSQL用户非常关心数据泄露和安全漏洞的处理，因为数据泄露和安全漏洞是不可避免的。用户通常使用安全审计、修补程序和紧急响应计划等技术手段来处理数据泄露和安全漏洞。  
  
  
#### [期望 PostgreSQL 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")  
  
  
#### [类似Oracle RAC架构的PostgreSQL已开源: 阿里云PolarDB for PostgreSQL云原生分布式开源数据库!](https://github.com/ApsaraDB/PolarDB-for-PostgreSQL "57258f76c37864c6e6d23383d05714ea")  
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")  
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")  
  
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
