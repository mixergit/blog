## 这么多人合作的PostgreSQL开源项目, 如何保持统一的代码风格? 原来有这个绝招  
                                                                                     
### 作者                                                                          
digoal                                                                            
                                                                                            
### 日期                                                                                          
2024-12-05                                                        
                                                   
### 标签                                                                        
PostgreSQL , PolarDB , DuckDB , 代码风格 , pgindent , pg_bsd_indent , pgperltidy , typedefs , objdump     
                                                                                                                
----                                                                                         
                                                                                                       
## 背景    
PostgreSQL是全球合作的开源项目, 这么多贡献者, 怎么能保持统一的代码风格呢? 估计很多人好奇.  
   
其实开源项目最大的幸福感肯定是拥有来自全球的开发者, 但是这也可能成为开源项目幸福的烦恼. 就像金庸小说里的两种武功: <b>北冥神功</b>、<b>吸星大法</b> 都是吸人内力的武功, 但是吸星大法有个致命的缺点, 吸收进去后会被反噬, 吸的越多死得越难看. 北冥神功就没有这个问题.  一个好的开源项目应该要有北冥神功的特质, 才敢吸收众多开发者的贡献.      
  
刚好最近在看PolarDB 开发镜像的build项目时, 在Dockerfile中发现了几条“奇怪”的命令, 感觉上对用户没有任何作用, 为什么要加这几条呢?  
  
https://github.com/ApsaraDB/polardb-pg-docker-images/blob/main/Dockerfile-devel-ubuntu24.04    
  
```  
COPY misc/pg_bsd_indent_$TARGETARCH /usr/bin/pg_bsd_indent  
  
# install perl module for TAP test  
RUN perl -MCPAN -e "CPAN::Shell->notest('install', 'SHANCOCK/Perl-Tidy-20230309.tar.gz')"  
```  
  
咨询了研发人员原来是开发者使用的, 继承自PostgreSQL的传统, 用来保持统一的代码风格.   
  
具体体现在2个环节中, `pgindent`调用了`pg_bsd_indent`和`pgperltidy`来检查代码风格, 同时依赖一个似乎是代码涉及到的所有符号表(typedefs.list)的文件.     
  
以下截取自`src/tools/pgindent/README`    
  
## 1 DOING THE INDENT RUN BEFORE A NORMAL COMMIT:  
  
1、把pg_bsd_indent放到PATH路径中, 例如  
```  
export GITHUB_PROXY=https://ghproxy.com/  
git clone --depth 1 -b REL_17_STABLE https://github.com/postgres/postgres  
cd postgres  
./configure --without-icu  
cd src/tools/pg_bsd_indent/  
make -j8  
```  
  
2、使用检查被修改过或新增的C文件    
  
例如, 使用pgindent对所有PostgreSQL文件进行检查  
```  
export PATH=src/tools/pg_bsd_indent:$PATH  
cd postgres   
src/tools/pgindent/pgindent .    
  
Usage:  
pgindent [OPTION]... [FILE|DIR]...  
Options:  
	--help                  show this message and quit  
	--commit=gitref         use files modified by the named commit  
	--typedefs=FILE         file containing a list of typedefs  
	--list-of-typedefs=STR  string containing typedefs, space separated  
	--excludes=PATH         file containing list of filename patterns to ignore  
	--indent=PATH           path to pg_bsd_indent program  
	--diff                  show the changes that would be made  
	--check                 exit with status 2 if any changes would be made  
The --excludes and --commit options can be given more than once.  
```  
  
3、使用`git status`检查是否有产生变化, 被检查修改过的文件的老文件会被保存(pgindent leaves *.BAK files behind if it has trouble, while  
   perltidy leaves *.LOG files behind. 后面这个是`src/tools/pgindent/pgperltidy`产生的.)    
  
```  
$ git status  
On branch REL_17_STABLE  
Your branch is up to date with 'origin/REL_17_STABLE'.  
  
nothing to commit, working tree clean  
```  
  
4、If pgindent wants to change anything your commit wasn't touching, stop and figure out why.  If it is making ugly whitespace changes around typedefs your commit adds, you need to add those typedefs to `src/tools/pgindent/typedefs.list`.  
  
生成typedefs.list的具体方法参考:   
- http://adpgtech.blogspot.com/2015/05/running-pgindent-on-non-core-code-or.html  
  
5、If you have the patience, it's worth eyeballing the "git diff" output for any egregiously ugly changes.  See below for cleanup ideas.  
  
6、Do a full test build:  
  
```  
        make -s clean  
        make -s all     # look for unexpected warnings, and errors of course  
        make check-world  
```  
  
Your configure switches should include at least `--enable-tap-tests` or else much of the Perl code won't get exercised. The ecpg regression tests may well fail due to pgindent's updates of header files that get copied into ecpg output; if so, adjust the expected-files to match.  
  
## 2 AT LEAST ONCE PER RELEASE CYCLE:  
  
1) Download the latest typedef file from the buildfarm:   
```  
wget -O src/tools/pgindent/typedefs.list https://buildfarm.postgresql.org/cgi-bin/typedefs.pl  
```  
  
This step resolves any differences between the incrementally updated version of the file and a clean, autogenerated one. (See https://buildfarm.postgresql.org/cgi-bin/typedefs.pl?show_list for a full list of typedef files, if you want to indent some back branch.)  
  
2) Run pgindent as above.  
  
3) Indent the Perl code using `perltidy`:  
```  
src/tools/pgindent/pgperltidy .  
```  
  
If you want to use some `perltidy` version that's not in your `PATH`, first set the `PERLTIDY` environment variable to point to it.  
  
4) Reformat the bootstrap catalog data files:  
```  
./configure     # "make" will not work in an unconfigured tree  
cd src/include/catalog  
make reformat-dat-files  
cd ../../..  
```  
  
5) When you're done, "`git commit`" everything including the typedefs.list file you used.  
  
6) Add the newly created commit(s) to the `.git-blame-ignore-revs` file so that "`git blame`" ignores the commits (for anybody that has opted-in to using the ignore file).  Follow the instructions that appear at the top of the `.git-blame-ignore-revs` file.  
  
Another "`git commit`" will be required for your ignore file changes.  
  
## 参考  
https://www.pgbuildfarm.org/cgi-bin/typedefs.pl?show_list  
  
https://www.pgbuildfarm.org/cgi-bin/typedefs.pl?branch=REL_17_STABLE  
  
src/tools/pgindent/README  
  
src/tools/pg_bsd_indent/README  
  
http://adpgtech.blogspot.com/2015/05/running-pgindent-on-non-core-code-or.html  
  
Running pgindent on non-core code, or development code  
  
Running pgindent is not nearly as hard as some people seem to think it is. The hardest part of getting a workable set of typedefs to use. That's why the buildfarm now constructs these lists automatically for each live branch.  
  
But that doesn't help if you're working on non-core code. Here's what I did to get a working typedefs list for the Redis FDW code:  
```  
objdump -W redis_fdw.so |\
 egrep -A3 DW_TAG_typedef |\
 perl -e ' while (<>) { chomp; @flds = split;next unless (1 < @flds);\
     next if $flds[0]  ne "DW_AT_name" && $flds[1] ne "DW_AT_name";\
     next if $flds[-1] =~ /^DW_FORM_str/;\
     print $flds[-1],"\n"; }'  |\
 sort | uniq > redis_fdw.typedefs  
```  
  
This is a slight adaptation of what the buildfarm code does on Linux to get a typedefs list.  
  
After that, indenting the code was a matter of just doing this:  
```  
pgindent --typedefs=redis_fdw.typedefs redis_fdw.c  
```  
  
What if you're developing a piece of core code and you'd like to run pgindent on it, but you've introduced some new typedefs, so pgindent mucks up the indentation by adding extraneous spaces. You have a couple of options. Let's assume that what you're working on is backend code. Then you could run the above extraction on the built backend - it doesn't have to be installed, just run it against `src/backend/postgres`. Then use that to run pgindent against each of the files you're working on. You don't have to run it separately for each file - you can name as many files to indent as you like on the command line.  
  
If you do that, look at the results carefully. It's possible that the absence of some platform-dependent typedef has mucked up your file. So a safer procedure is to grab the latest typedefs list from the buildfarm server and combine it with the typedefs list you just constructed, like this:  
```  
wget -q -O - "http://www.pgbuildfarm.org/cgi-bin/typedefs.pl?branch=HEAD" |\
 cat - mytypedefs | sort | uniq > mynewtypedefs  
```  
  
and then use that file to pgindent your code.  
  
None of this is as easy as it might be. But none of it is very hard either.  
  
Addendum  
  
If you only have a handful of new typedefs, you can pass them on the command line to pgindent, like this:  
```  
pgindent --typedefs=mytypedefs --list-of-typedefs="typedef1 typedef2" myfile1.c myfile2.c  
```  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
